# ğŸš€ æ€§èƒ½æµ‹è¯•ä½¿ç”¨æŒ‡å—

> è®©æ‚¨çš„ç³»ç»Ÿåœ¨å‹åŠ›ä¸‹ä¾ç„¶ä¼˜é›…å¦‚åˆï¼è¿™é‡Œæ˜¯æ€§èƒ½æµ‹è¯•çš„å®Œæ•´æ”»ç•¥ âš¡

## ğŸ¯ æ€§èƒ½æµ‹è¯•æ¦‚è¿°

### ä»€ä¹ˆæ˜¯æ€§èƒ½æµ‹è¯•ï¼Ÿ

æ€§èƒ½æµ‹è¯•å°±åƒç»™æ‚¨çš„ç³»ç»Ÿåš**ä½“æ£€**ï¼Œé€šè¿‡æ¨¡æ‹Ÿå¤§é‡ç”¨æˆ·åŒæ—¶è®¿é—®ï¼Œæ£€éªŒç³»ç»Ÿåœ¨é«˜è´Ÿè½½ä¸‹çš„è¡¨ç°ï¼š

- **å“åº”æ—¶é—´** - ç³»ç»Ÿå¤„ç†è¯·æ±‚çš„é€Ÿåº¦
- **ååé‡** - å•ä½æ—¶é—´å†…å¤„ç†çš„è¯·æ±‚æ•°é‡
- **å¹¶å‘èƒ½åŠ›** - åŒæ—¶å¤„ç†ç”¨æˆ·çš„æœ€å¤§æ•°é‡
- **ç¨³å®šæ€§** - é•¿æ—¶é—´è¿è¡Œçš„å¯é æ€§
- **èµ„æºä½¿ç”¨** - CPUã€å†…å­˜ã€ç½‘ç»œçš„ä½¿ç”¨æƒ…å†µ

### ä¸ºä»€ä¹ˆé€‰æ‹©Locustï¼Ÿ

æˆ‘ä»¬é€‰æ‹©**Locust**ä½œä¸ºæ€§èƒ½æµ‹è¯•æ¡†æ¶ï¼Œå› ä¸ºå®ƒï¼š

- ğŸ **Pythonç¼–å†™** - ä¸å¹³å°æŠ€æœ¯æ ˆå®Œç¾èåˆ
- ğŸ“Š **å®æ—¶ç›‘æ§** - æä¾›ç¾è§‚çš„Webç•Œé¢
- ğŸ”§ **çµæ´»é…ç½®** - æ”¯æŒå¤æ‚çš„æµ‹è¯•åœºæ™¯
- ğŸ“ˆ **å¯æ‰©å±•** - æ”¯æŒåˆ†å¸ƒå¼æµ‹è¯•
- ğŸ¯ **æ˜“äºä½¿ç”¨** - ç®€æ´çš„APIè®¾è®¡

## ğŸ—ï¸ æ€§èƒ½æµ‹è¯•æ¶æ„

### æµ‹è¯•ç»„ä»¶ç»“æ„

```
ğŸ­ Locustæµ‹è¯•è„šæœ¬ (LocustFunc)
    â””â”€â”€ ğŸ“Š è´Ÿè½½å½¢çŠ¶é…ç½® (LocustShape)
        â””â”€â”€ ğŸ“¦ æµ‹è¯•å¥—ä»¶ (LocustSuite)
            â””â”€â”€ ğŸ“ˆ æµ‹è¯•ç»“æœ (LocustTestResult)
```

### æ‰§è¡Œæµç¨‹

```mermaid
graph TD
    A[ç¼–å†™æµ‹è¯•è„šæœ¬] --> B[é…ç½®è´Ÿè½½å‚æ•°]
    B --> C[åˆ›å»ºæµ‹è¯•å¥—ä»¶]
    C --> D[å¯åŠ¨æ€§èƒ½æµ‹è¯•]
    D --> E[å®æ—¶ç›‘æ§]
    E --> F[ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š]
    F --> G[åˆ†æç»“æœ]
```

## ğŸ“ ç¼–å†™æ€§èƒ½æµ‹è¯•è„šæœ¬

### åŸºç¡€è„šæœ¬ç»“æ„

```python
from locust import HttpUser, task, between

class WebsiteUser(HttpUser):
    """
    ç½‘ç«™ç”¨æˆ·è¡Œä¸ºæ¨¡æ‹Ÿ

    æ¨¡æ‹Ÿç”¨æˆ·åœ¨ç½‘ç«™ä¸Šçš„å…¸å‹æ“ä½œï¼š
    - è®¿é—®é¦–é¡µ
    - ç”¨æˆ·ç™»å½•
    - æµè§ˆå•†å“
    - ä¸‹å•è´­ä¹°
    """

    wait_time = between(1, 3)  # ç”¨æˆ·æ“ä½œé—´éš”1-3ç§’

    def on_start(self):
        """ç”¨æˆ·å¼€å§‹æµ‹è¯•æ—¶çš„åˆå§‹åŒ–æ“ä½œ"""
        self.login()

    def login(self):
        """ç”¨æˆ·ç™»å½•"""
        response = self.client.post("/api/user/login", json={
            "username": "test_user",
            "password": "test_password"
        })
        if response.status_code == 200:
            self.token = response.json().get("token")

    @task(3)  # æƒé‡ä¸º3ï¼Œæ‰§è¡Œé¢‘ç‡è¾ƒé«˜
    def view_homepage(self):
        """è®¿é—®é¦–é¡µ"""
        self.client.get("/")

    @task(2)  # æƒé‡ä¸º2
    def view_products(self):
        """æµè§ˆå•†å“åˆ—è¡¨"""
        self.client.get("/api/goods/get/by?current=1&pageSize=10")

    @task(1)  # æƒé‡ä¸º1ï¼Œæ‰§è¡Œé¢‘ç‡è¾ƒä½
    def create_order(self):
        """åˆ›å»ºè®¢å•"""
        if hasattr(self, 'token'):
            headers = {"Authorization": f"Bearer {self.token}"}
            self.client.post("/api/orders/create",
                           json={"product_id": 1, "quantity": 1},
                           headers=headers)
```

### é«˜çº§è„šæœ¬ç‰¹æ€§

**1. æ•°æ®é©±åŠ¨æµ‹è¯•**

```python
import random
from locust import HttpUser, task

class DataDrivenUser(HttpUser):
    """æ•°æ®é©±åŠ¨çš„æ€§èƒ½æµ‹è¯•"""

    def on_start(self):
        # å‡†å¤‡æµ‹è¯•æ•°æ®
        self.test_users = [
            {"username": "user1", "password": "pass1"},
            {"username": "user2", "password": "pass2"},
            {"username": "user3", "password": "pass3"},
        ]

    @task
    def login_with_random_user(self):
        """ä½¿ç”¨éšæœºç”¨æˆ·ç™»å½•"""
        user_data = random.choice(self.test_users)
        self.client.post("/api/user/login", json=user_data)
```

**2. è‡ªå®šä¹‰è´Ÿè½½å½¢çŠ¶**

```python
from locust import LoadTestShape

class StepLoadShape(LoadTestShape):
    """
    é˜¶æ¢¯å¼è´Ÿè½½å¢é•¿

    æ¨¡æ‹ŸçœŸå®åœºæ™¯ä¸­ç”¨æˆ·æ•°é‡çš„é€æ­¥å¢é•¿ï¼š
    0-60ç§’ï¼š10ä¸ªç”¨æˆ·
    60-120ç§’ï¼š50ä¸ªç”¨æˆ·
    120-180ç§’ï¼š100ä¸ªç”¨æˆ·
    """

    step_time = 60
    step_load = 10
    spawn_rate = 10
    time_limit = 180

    def tick(self):
        run_time = self.get_run_time()

        if run_time < self.time_limit:
            current_step = run_time // self.step_time
            return (self.step_load * (current_step + 1), self.spawn_rate)

        return None
```

## ğŸ›ï¸ æµ‹è¯•é…ç½®ç®¡ç†

### åŒæ­¥æµ‹è¯•è„šæœ¬

å¹³å°ä¼šè‡ªåŠ¨å‘ç°å’ŒåŒæ­¥Locustæµ‹è¯•è„šæœ¬ï¼š

1. **è„šæœ¬ç›®å½•ç»“æ„**
```
locust_tests/
â”œâ”€â”€ user_scenarios/
â”‚   â”œâ”€â”€ login_test.py
â”‚   â””â”€â”€ registration_test.py
â”œâ”€â”€ api_scenarios/
â”‚   â”œâ”€â”€ goods_api_test.py
â”‚   â””â”€â”€ order_api_test.py
â””â”€â”€ mixed_scenarios/
    â””â”€â”€ full_workflow_test.py
```

2. **åŒæ­¥æ“ä½œ**
```bash
POST /api/locust_test/sync_locust_moudle
```

ç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
- æ‰«ææµ‹è¯•ç›®å½•
- è§£æè„šæœ¬æ–‡æ¡£å­—ç¬¦ä¸²
- æå–æµ‹è¯•åœºæ™¯ä¿¡æ¯
- æ›´æ–°æ•°æ®åº“è®°å½•

### è´Ÿè½½å½¢çŠ¶é…ç½®

åˆ›å»ºä¸åŒçš„è´Ÿè½½æ¨¡å¼ï¼š

```json
{
  "shape_name": "é˜¶æ¢¯å¼è´Ÿè½½",
  "shape_desc": "æ¨¡æ‹Ÿç”¨æˆ·æ•°é‡é€æ­¥å¢é•¿çš„åœºæ™¯",
  "shape_type": "step",
  "max_users": 100,
  "spawn_rate": 10,
  "duration": 300
}
```

**å¸¸ç”¨è´Ÿè½½æ¨¡å¼ï¼š**

- **æ’å®šè´Ÿè½½** - å›ºå®šç”¨æˆ·æ•°æŒç»­æµ‹è¯•
- **é˜¶æ¢¯è´Ÿè½½** - ç”¨æˆ·æ•°åˆ†é˜¶æ®µå¢é•¿
- **å³°å€¼è´Ÿè½½** - å¿«é€Ÿè¾¾åˆ°æœ€å¤§ç”¨æˆ·æ•°
- **æ³¢æµªè´Ÿè½½** - ç”¨æˆ·æ•°å‘¨æœŸæ€§å˜åŒ–

## ğŸ“¦ æµ‹è¯•å¥—ä»¶ç®¡ç†

### åˆ›å»ºæ€§èƒ½æµ‹è¯•å¥—ä»¶

å°†ç›¸å…³çš„æ€§èƒ½æµ‹è¯•è„šæœ¬ç»„åˆæˆå¥—ä»¶ï¼š

```json
{
  "suite_name": "ç”µå•†ç³»ç»Ÿæ€§èƒ½æµ‹è¯•å¥—ä»¶",
  "suite_desc": "åŒ…å«ç”¨æˆ·ç™»å½•ã€å•†å“æµè§ˆã€è®¢å•åˆ›å»ºç­‰æ ¸å¿ƒæµç¨‹çš„æ€§èƒ½æµ‹è¯•",
  "locust_func_ids": [1, 2, 3, 5],
  "shape_id": 1,
  "test_env": "test"
}
```

### å¥—ä»¶æ‰§è¡Œé…ç½®

- **å¹¶å‘ç”¨æˆ·æ•°** - åŒæ—¶æ‰§è¡Œçš„è™šæ‹Ÿç”¨æˆ·æ•°é‡
- **å¢é•¿é€Ÿç‡** - ç”¨æˆ·æ•°å¢é•¿çš„é€Ÿåº¦
- **æµ‹è¯•æ—¶é•¿** - æµ‹è¯•æ‰§è¡Œçš„æ€»æ—¶é—´
- **ç›®æ ‡ä¸»æœº** - è¢«æµ‹è¯•ç³»ç»Ÿçš„åœ°å€

## ğŸš€ æ‰§è¡Œæ€§èƒ½æµ‹è¯•

### å¯åŠ¨æµ‹è¯•

```bash
POST /api/locust_test/run_locust_test
```

```json
{
  "suite_id": 1,
  "title": "ç”µå•†ç³»ç»Ÿå‹åŠ›æµ‹è¯•-åŒ11é¢„æ¼”",
  "users": 100,
  "spawn_rate": 10,
  "run_time": "10m",
  "host": "https://test-api.example.com"
}
```

### å®æ—¶ç›‘æ§

æµ‹è¯•æ‰§è¡Œè¿‡ç¨‹ä¸­å¯ä»¥å®æ—¶æŸ¥çœ‹ï¼š

**ğŸ“Š å…³é”®æŒ‡æ ‡**
- **RPS** (Requests Per Second) - æ¯ç§’è¯·æ±‚æ•°
- **å“åº”æ—¶é—´** - å¹³å‡ã€æœ€å°ã€æœ€å¤§å“åº”æ—¶é—´
- **é”™è¯¯ç‡** - è¯·æ±‚å¤±è´¥çš„ç™¾åˆ†æ¯”
- **å¹¶å‘ç”¨æˆ·æ•°** - å½“å‰æ´»è·ƒçš„è™šæ‹Ÿç”¨æˆ·æ•°

**ğŸ“ˆ å®æ—¶å›¾è¡¨**
- å“åº”æ—¶é—´è¶‹åŠ¿å›¾
- RPSå˜åŒ–æ›²çº¿
- é”™è¯¯ç‡ç»Ÿè®¡å›¾
- ç”¨æˆ·æ•°å¢é•¿å›¾

### æµ‹è¯•æ§åˆ¶

æµ‹è¯•æ‰§è¡Œè¿‡ç¨‹ä¸­æ”¯æŒï¼š

- **æš‚åœ/æ¢å¤** - ä¸´æ—¶æš‚åœæµ‹è¯•æ‰§è¡Œ
- **åœæ­¢æµ‹è¯•** - æå‰ç»“æŸæµ‹è¯•
- **è°ƒæ•´è´Ÿè½½** - åŠ¨æ€ä¿®æ”¹ç”¨æˆ·æ•°å’Œå¢é•¿ç‡
- **æŸ¥çœ‹æ—¥å¿—** - å®æ—¶æŸ¥çœ‹æµ‹è¯•æ—¥å¿—

## ğŸ“Š ç»“æœåˆ†æ

### æµ‹è¯•æŠ¥å‘Š

æµ‹è¯•å®Œæˆåè‡ªåŠ¨ç”Ÿæˆè¯¦ç»†æŠ¥å‘Šï¼š

**ğŸ“‹ æ¦‚è§ˆä¿¡æ¯**
```
æµ‹è¯•æ—¶é•¿: 10åˆ†é’Ÿ
æ€»è¯·æ±‚æ•°: 15,432
æˆåŠŸè¯·æ±‚: 15,201 (98.5%)
å¤±è´¥è¯·æ±‚: 231 (1.5%)
å¹³å‡RPS: 25.7
å¹³å‡å“åº”æ—¶é—´: 245ms
```

**ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡**
- **å“åº”æ—¶é—´åˆ†å¸ƒ** - 50%ã€90%ã€95%ã€99%åˆ†ä½æ•°
- **RPSç»Ÿè®¡** - æœ€å¤§ã€æœ€å°ã€å¹³å‡RPS
- **é”™è¯¯åˆ†æ** - é”™è¯¯ç±»å‹å’Œåˆ†å¸ƒ
- **èµ„æºä½¿ç”¨** - ç³»ç»Ÿèµ„æºæ¶ˆè€—æƒ…å†µ

### æ€§èƒ½åŸºçº¿

å»ºç«‹æ€§èƒ½åŸºçº¿ï¼Œç”¨äºå¯¹æ¯”åˆ†æï¼š

```json
{
  "baseline_name": "ç”µå•†ç³»ç»Ÿv1.0æ€§èƒ½åŸºçº¿",
  "avg_response_time": 245,
  "max_rps": 45,
  "error_rate": 1.5,
  "cpu_usage": 65,
  "memory_usage": 78
}
```

### è¶‹åŠ¿åˆ†æ

å¯¹æ¯”å†å²æµ‹è¯•ç»“æœï¼Œåˆ†ææ€§èƒ½è¶‹åŠ¿ï¼š

- **æ€§èƒ½å›å½’** - è¯†åˆ«æ€§èƒ½ä¸‹é™çš„ç‰ˆæœ¬
- **å®¹é‡è§„åˆ’** - é¢„æµ‹ç³»ç»Ÿå®¹é‡éœ€æ±‚
- **ä¼˜åŒ–æ•ˆæœ** - éªŒè¯æ€§èƒ½ä¼˜åŒ–çš„æ•ˆæœ
- **ç“¶é¢ˆè¯†åˆ«** - å‘ç°ç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆ

## ğŸ¯ æœ€ä½³å®è·µ

### æµ‹è¯•ç­–ç•¥

**1. åˆ†å±‚æµ‹è¯•**
```
ğŸ”¹ å•æ¥å£æ€§èƒ½æµ‹è¯• - éªŒè¯å•ä¸ªAPIçš„æ€§èƒ½
ğŸ”¹ ä¸šåŠ¡æµç¨‹æ€§èƒ½æµ‹è¯• - æµ‹è¯•å®Œæ•´ä¸šåŠ¡æµç¨‹
ğŸ”¹ æ··åˆåœºæ™¯æ€§èƒ½æµ‹è¯• - æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸º
ğŸ”¹ æé™å‹åŠ›æµ‹è¯• - æ‰¾åˆ°ç³»ç»Ÿçš„æ€§èƒ½è¾¹ç•Œ
```

**2. æµ‹è¯•ç¯å¢ƒ**
- ä½¿ç”¨ä¸ç”Ÿäº§ç¯å¢ƒç›¸ä¼¼çš„æµ‹è¯•ç¯å¢ƒ
- ç¡®ä¿æµ‹è¯•æ•°æ®çš„å……åˆ†æ€§å’ŒçœŸå®æ€§
- éš”ç¦»æµ‹è¯•ç¯å¢ƒï¼Œé¿å…å¹²æ‰°

**3. ç›‘æ§ç­–ç•¥**
- åŒæ—¶ç›‘æ§åº”ç”¨å’ŒåŸºç¡€è®¾æ–½æŒ‡æ ‡
- è®¾ç½®åˆç†çš„æ€§èƒ½é˜ˆå€¼å’Œå‘Šè­¦
- è®°å½•è¯¦ç»†çš„æµ‹è¯•æ—¥å¿—

### è„šæœ¬ä¼˜åŒ–

**1. æ€§èƒ½ä¼˜åŒ–**
```python
# ä½¿ç”¨è¿æ¥æ± 
from locust import HttpUser
import requests

class OptimizedUser(HttpUser):
    def on_start(self):
        # é…ç½®è¿æ¥æ± 
        self.client.mount('http://', requests.adapters.HTTPAdapter(
            pool_connections=10,
            pool_maxsize=10
        ))
```

**2. æ•°æ®ç®¡ç†**
```python
# é¿å…æ•°æ®ç«äº‰
import threading

class ThreadSafeUser(HttpUser):
    def on_start(self):
        # ä½¿ç”¨çº¿ç¨‹æœ¬åœ°å­˜å‚¨
        self.local_data = threading.local()
        self.local_data.user_id = self.generate_unique_user_id()
```

### ç»“æœè§£è¯»

**1. å…³é”®æŒ‡æ ‡ç†è§£**
- **å“åº”æ—¶é—´** < 200ms (ä¼˜ç§€), < 500ms (è‰¯å¥½), > 1s (éœ€è¦ä¼˜åŒ–)
- **é”™è¯¯ç‡** < 0.1% (ä¼˜ç§€), < 1% (å¯æ¥å—), > 5% (ä¸¥é‡é—®é¢˜)
- **RPS** æ ¹æ®ä¸šåŠ¡éœ€æ±‚ç¡®å®šç›®æ ‡å€¼

**2. ç“¶é¢ˆè¯†åˆ«**
- **CPUç“¶é¢ˆ** - å“åº”æ—¶é—´éšç”¨æˆ·æ•°çº¿æ€§å¢é•¿
- **å†…å­˜ç“¶é¢ˆ** - å‡ºç°å†…å­˜æº¢å‡ºé”™è¯¯
- **æ•°æ®åº“ç“¶é¢ˆ** - æ•°æ®åº“ç›¸å…³æ“ä½œå“åº”æ—¶é—´è¿‡é•¿
- **ç½‘ç»œç“¶é¢ˆ** - ç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…ç‡é«˜

---

*æ€§èƒ½æµ‹è¯•å°±åƒç»™ç³»ç»Ÿåšé©¬æ‹‰æ¾è®­ç»ƒï¼Œåªæœ‰ç»è¿‡å……åˆ†çš„å‹åŠ›æµ‹è¯•ï¼Œç³»ç»Ÿæ‰èƒ½åœ¨å…³é”®æ—¶åˆ»ä¿æŒæœ€ä½³çŠ¶æ€ ğŸƒâ€â™‚ï¸*
